# æ ¸å¿ƒå·¥å…·æ¨¡å—

> apm-installer / apm-store / apm-update-tool - å®‰è£…ã€å•†åº—ä¸æ›´æ–°å·¥å…·

## æ¨¡å—æ¦‚è§ˆ

### æ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | è·¯å¾„ | æè¿° |
|------|------|------|
| apm-installer | `src/usr/bin/apm-installer` | è½¯ä»¶åŒ…å®‰è£…ä¸å¸è½½å·¥å…· |
| apm-store | `src/usr/bin/apm-store` | å•†åº—å¯åŠ¨å™¨ |
| apm-update-tool | `src/usr/bin/apm-update-tool` | æ›´æ–°æ£€æŸ¥å·¥å…· |

### åŠŸèƒ½èŒè´£

| å·¥å…· | èŒè´£ |
|------|------|
| **apm-installer** | æä¾›äº¤äº’å¼çš„è½¯ä»¶åŒ…å®‰è£…ã€å¸è½½ç•Œé¢ï¼Œæ”¯æŒæ‰¹é‡æ“ä½œ |
| **apm-store** | æ ¹æ®ç³»ç»Ÿæ¶æ„æ‰“å¼€å¯¹åº”çš„ Web å•†åº—é¡µé¢ |
| **apm-update-tool** | æ£€æŸ¥å¹¶æ˜¾ç¤ºå¯å‡çº§çš„è½¯ä»¶åŒ…åˆ—è¡¨ |

### æ¨¡å—å…³ç³»å›¾

```mermaid
graph TB
    subgraph "æ ¸å¿ƒå·¥å…·æ¨¡å—"
        Store[apm-store<br/>å•†åº—å¯åŠ¨å™¨]
        Installer[apm-installer<br/>å®‰è£…/å¸è½½å·¥å…·]
        Updater[apm-update-tool<br/>æ›´æ–°å·¥å…·]
    end

    subgraph "ç³»ç»Ÿä¾èµ–"
        APM[APM åŒ…ç®¡ç†å™¨]
        Zenity[Zenity å¯¹è¯æ¡†]
        XDGOpen[xdg-open]
        PolicyKit[pkexec]
    end

    subgraph "å¤–éƒ¨èµ„æº"
        WebAMD64[(Web å•†åº—<br/>AMD64)]
        WebARM64[(Web å•†åº—<br/>ARM64)]
        APMRoot[(APM åŒ…æ•°æ®åº“<br/>/var/lib/apm)]
    end

    Store -->|æ‰“å¼€| XDGOpen
    XDGOpen -->|x86_64| WebAMD64
    XDGOpen -->|aarch64| WebARM64

    Installer -->|æƒé™æå‡| PolicyKit
    Installer -->|å®‰è£…/å¸è½½| APM
    Installer -->|æ˜¾ç¤ºå¯¹è¯æ¡†| Zenity
    Installer -->|è¯»å–| APMRoot

    Updater -->|æŸ¥è¯¢| APM
```

---

## apm-installer å®‰è£…å·¥å…·

### åŠŸèƒ½æ¦‚è¿°

`apm-installer` æ˜¯ä¸€ä¸ªå¤šåŠŸèƒ½çš„åŒ…ç®¡ç†å·¥å…·ï¼Œæä¾›ï¼š
- ğŸ“¥ äº¤äº’å¼è½¯ä»¶åŒ…å®‰è£…
- ğŸ—‘ï¸ å›¾å½¢åŒ–æ‰¹é‡å¸è½½ç•Œé¢
- ğŸ” è‡ªåŠ¨æƒé™æå‡

### å‡½æ•°å®šä¹‰

```bash
# ä½¿ç”¨è¯´æ˜
show_usage() {
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo "é€‰é¡¹:"
    echo "  --list                åˆ—å‡ºå¯å¸è½½çš„åŒ…"
    echo "  --install <åŒ…å>      å®‰è£…æŒ‡å®šçš„ Debian åŒ…"
}

# Debian åŒ…åéªŒè¯å‡½æ•°
is_valid_deb_package() {
    local package="$1"
    if [[ "$package" =~ ^[a-z0-9][a-z0-9+-.]*$ ]]; then
        return 0
    else
        return 1
    fi
}
```

### ç±»/å‡½æ•°ç»§æ‰¿å…³ç³»

```mermaid
classDiagram
    class ApmInstaller {
        +main(args)
        +show_usage()
        +is_valid_deb_package(package)
        +list_packages()
        +install_package(name)
    }
    
    class ListMode {
        +scan_apm_root()
        +parse_desktop_files()
        +show_zenity_dialog()
        +confirm_uninstall()
        +execute_uninstall()
    }
    
    class InstallMode {
        +validate_package()
        +prompt_confirm()
        +call_apm_install()
    }
    
    ApmInstaller --> ListMode : --list
    ApmInstaller --> InstallMode : --install
```

### æ ¸å¿ƒå®ç°

#### æƒé™æå‡æœºåˆ¶

**æ–‡ä»¶è·¯å¾„**: `src/usr/bin/apm-installer`

```bash
# æ£€æŸ¥æ˜¯å¦ä¸º root ç”¨æˆ·ï¼Œå¦‚æœä¸æ˜¯åˆ™ç”¨ pkexec é‡æ–°æ‰§è¡Œ
if [[ $EUID -ne 0 ]]; then
    exec pkexec "$0" "$@"
fi
```

#### ä¼ªä»£ç æè¿° - å¸è½½åˆ—è¡¨æ¨¡å¼

```
å‡½æ•° list_packages():
    1. å®šä¹‰ APM_ROOT = "/var/lib/apm/apm/files/ace-env/var/lib/apm"
    2. åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨åŒ…åˆ—è¡¨
    
    3. éå† APM_ROOT ä¸‹æ‰€æœ‰ç›®å½•:
        a. è·å–åŒ…å = ç›®å½•å
        b. æŸ¥æ‰¾ .desktop æ–‡ä»¶
        c. æå–åº”ç”¨åç§° (ä¼˜å…ˆ zh_CN)
        d. å­˜å‚¨æ˜ å°„å…³ç³» pkg -> app_name
        e. å†™å…¥ä¸´æ—¶æ–‡ä»¶: "FALSE|åº”ç”¨å|åŒ…å"
    
    4. å¦‚æœæ— åŒ…:
        æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†
        é€€å‡º
    
    5. è°ƒç”¨ zenity æ˜¾ç¤ºå¤é€‰æ¡†åˆ—è¡¨
    6. è·å–ç”¨æˆ·é€‰æ‹©
    
    7. æ„å»ºç¡®è®¤æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºåº”ç”¨åç§°ï¼‰
    8. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    
    9. å¦‚æœç¡®è®¤:
        éå†é€‰ä¸­çš„åŒ…:
            apm autopurge $pkg -y
            æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
    
    10. æ˜¾ç¤ºå®Œæˆé€šçŸ¥
```

#### å®ç°ç»†èŠ‚è¡¨æ ¼ - åŒ…ä¿¡æ¯æå–

| æ­¥éª¤ | æ“ä½œ | ä»£ç ç‰‡æ®µ |
|------|------|---------|
| 1 | æŸ¥æ‰¾ desktop æ–‡ä»¶ | `desktop_files=("$pkgdir"/entries/applications/*.desktop)` |
| 2 | æå–ä¸­æ–‡åç§° | `grep -P '^Name\[zh_CN\]=' "$desktop_file"` |
| 3 | å›é€€åˆ°é»˜è®¤åç§° | `grep -P '^Name=' "$desktop_file"` |
| 4 | æ¸…ç†å­—æ®µ | `desktop_name=${desktop_name//$'\r'/ }` |

### æµç¨‹å›¾

#### å¸è½½æµç¨‹å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹ --list]) --> CheckRoot{æ˜¯å¦ root?}
    CheckRoot -->|å¦| Pkexec[pkexec é‡æ–°æ‰§è¡Œ]
    Pkexec --> CheckRoot
    CheckRoot -->|æ˜¯| ScanPkgs[æ‰«æ APM åŒ…ç›®å½•]
    
    ScanPkgs --> Loop{éå†ç›®å½•}
    Loop --> ParseDesktop[è§£æ .desktop æ–‡ä»¶]
    ParseDesktop --> ExtractName[æå–åº”ç”¨åç§°]
    ExtractName --> StoreMap[å­˜å‚¨åŒ…åæ˜ å°„]
    StoreMap --> WriteTemp[å†™å…¥ä¸´æ—¶æ–‡ä»¶]
    WriteTemp --> Loop
    
    Loop -->|å®Œæˆ| CheckEmpty{åˆ—è¡¨ä¸ºç©º?}
    CheckEmpty -->|æ˜¯| ShowError[æ˜¾ç¤ºé”™è¯¯]
    ShowError --> End1([ç»“æŸ])
    
    CheckEmpty -->|å¦| ShowZenity[æ˜¾ç¤º Zenity åˆ—è¡¨]
    ShowZenity --> GetSelection[è·å–ç”¨æˆ·é€‰æ‹©]
    GetSelection --> CheckSelection{æœ‰é€‰æ‹©?}
    CheckSelection -->|å¦| End2([ç»“æŸ])
    
    CheckSelection -->|æ˜¯| BuildConfirm[æ„å»ºç¡®è®¤æ¶ˆæ¯]
    BuildConfirm --> ShowConfirm[æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†]
    ShowConfirm --> Confirmed{ç¡®è®¤å¸è½½?}
    Confirmed -->|å¦| End3([ç»“æŸ])
    
    Confirmed -->|æ˜¯| UninstallLoop{éå†é€‰ä¸­åŒ…}
    UninstallLoop --> CallAPM[apm autopurge pkg -y]
    CallAPM --> ShowProgress[æ˜¾ç¤ºè¿›åº¦]
    ShowProgress --> UninstallLoop
    
    UninstallLoop -->|å®Œæˆ| ShowDone[æ˜¾ç¤ºå®Œæˆ]
    ShowDone --> End4([ç»“æŸ])
```

#### å®‰è£…æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Installer as apm-installer
    participant PolicyKit as PolicyKit
    participant APM as APM
    
    User->>Installer: --install package-name
    
    alt é root ç”¨æˆ·
        Installer->>PolicyKit: pkexec è¯·æ±‚
        PolicyKit->>User: è®¤è¯å¯¹è¯æ¡†
        User->>PolicyKit: è¾“å…¥å¯†ç 
        PolicyKit->>Installer: ä»¥ root é‡æ–°æ‰§è¡Œ
    end
    
    Installer->>Installer: éªŒè¯åŒ…åæ ¼å¼
    
    alt åŒ…åæ— æ•ˆ
        Installer-->>User: é”™è¯¯: åŒ…åä¸ç¬¦åˆè§„èŒƒ
    else åŒ…åæœ‰æ•ˆ
        Installer->>User: æ˜¾ç¤ºç¡®è®¤æç¤º
        User->>Installer: è¾“å…¥ Y ç¡®è®¤
        Installer->>APM: apm install package-name
        APM-->>User: å®‰è£…è¿›åº¦
        APM-->>Installer: è¿”å›ç»“æœ
        Installer-->>User: æŒ‰å›è½¦é€€å‡º
    end
```

---

## apm-store å•†åº—å¯åŠ¨å™¨

### åŠŸèƒ½æ¦‚è¿°

`apm-store` æ ¹æ®å½“å‰ç³»ç»Ÿæ¶æ„è‡ªåŠ¨æ‰“å¼€å¯¹åº”çš„ Web å•†åº—é¡µé¢ã€‚

### æ ¸å¿ƒå®ç°

**æ–‡ä»¶è·¯å¾„**: `src/usr/bin/apm-store`

```bash
#!/bin/bash

# è·å–ç³»ç»Ÿæ¶æ„
arch=$(uname -m)

# æ ¹æ®æ¶æ„æ‰§è¡Œä¸åŒæ“ä½œ
case $arch in
    x86_64|i386|i686)
        xdg-open "https://erotica.spark-app.store/amd64-apm/index-client.html"
        ;;
    aarch64|armv7l|armv8l)
        xdg-open "https://erotica.spark-app.store/arm64-apm/index-client.html"
        ;;
    *)
        zenity --error --text="æš‚ä¸æ”¯æŒæ­¤æ¶æ„: $arch" --title="æ¶æ„ä¸æ”¯æŒ"
        ;;
esac
```

### æ¶æ„æ˜ å°„è¡¨

| ç³»ç»Ÿæ¶æ„ | å•†åº— URL |
|---------|---------|
| x86_64 / i386 / i686 | `https://erotica.spark-app.store/amd64-apm/index-client.html` |
| aarch64 / armv7l / armv8l | `https://erotica.spark-app.store/arm64-apm/index-client.html` |
| å…¶ä»– | æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡† |

### æµç¨‹å›¾

```mermaid
flowchart TD
    Start([å¼€å§‹]) --> GetArch[è·å–ç³»ç»Ÿæ¶æ„<br/>uname -m]
    GetArch --> CheckArch{æ¶æ„åˆ¤æ–­}
    
    CheckArch -->|x86_64/i386/i686| OpenAMD64[æ‰“å¼€ AMD64 å•†åº—]
    CheckArch -->|aarch64/armv7l/armv8l| OpenARM64[æ‰“å¼€ ARM64 å•†åº—]
    CheckArch -->|å…¶ä»–| ShowError[æ˜¾ç¤ºé”™è¯¯å¯¹è¯æ¡†]
    
    OpenAMD64 --> End([ç»“æŸ])
    OpenARM64 --> End
    ShowError --> End
```

---

## apm-update-tool æ›´æ–°å·¥å…·

### åŠŸèƒ½æ¦‚è¿°

`apm-update-tool` æ˜¾ç¤ºå¯å‡çº§çš„è½¯ä»¶åŒ…åˆ—è¡¨ï¼Œå¹¶æç¤ºç”¨æˆ·å¦‚ä½•è¿›è¡Œæ›´æ–°ã€‚

### æ ¸å¿ƒå®ç°

**æ–‡ä»¶è·¯å¾„**: `src/usr/bin/apm-update-tool`

```bash
#!/usr/bin/env bash

apm list --upgradable
echo
echo "----å¯é€šè¿‡ sudo apm full-upgrade -y è¿›è¡Œæ›´æ–°----"
echo
echo "è¯·æŒ‰å›è½¦é€€å‡º...."
read
```

### æµç¨‹å›¾

```mermaid
flowchart LR
    Start([å¼€å§‹]) --> ListUpgradable[apm list --upgradable]
    ListUpgradable --> ShowHint[æ˜¾ç¤ºæ›´æ–°æç¤º]
    ShowHint --> WaitInput[ç­‰å¾…ç”¨æˆ·æŒ‰å›è½¦]
    WaitInput --> End([ç»“æŸ])
```

### çŠ¶æ€å›¾

```mermaid
stateDiagram-v2
    [*] --> æŸ¥è¯¢å¯å‡çº§åŒ…
    æŸ¥è¯¢å¯å‡çº§åŒ… --> æ˜¾ç¤ºåˆ—è¡¨
    æ˜¾ç¤ºåˆ—è¡¨ --> æ˜¾ç¤ºæç¤ºä¿¡æ¯
    æ˜¾ç¤ºæç¤ºä¿¡æ¯ --> ç­‰å¾…ç”¨æˆ·è¾“å…¥
    ç­‰å¾…ç”¨æˆ·è¾“å…¥ --> [*] : ç”¨æˆ·æŒ‰å›è½¦
```

---

## å·¥å…·å¯¹æ¯”è¡¨

| ç‰¹æ€§ | apm-installer | apm-store | apm-update-tool |
|------|--------------|-----------|-----------------|
| éœ€è¦ root æƒé™ | âœ… | âŒ | âŒ |
| å›¾å½¢ç•Œé¢ | âœ… Zenity | âŒ æµè§ˆå™¨ | âŒ |
| äº¤äº’æ–¹å¼ | å¯¹è¯æ¡† | æ‰“å¼€ URL | ç»ˆç«¯ |
| ä¸»è¦åŠŸèƒ½ | å®‰è£…/å¸è½½ | æ‰“å¼€å•†åº— | æ£€æŸ¥æ›´æ–° |
| ä¾èµ– | apm, zenity | xdg-open | apm |

## å¯¼èˆªé“¾æ¥

| ä¸Šä¸€ç¯‡ | ç›®å½• | ä¸‹ä¸€ç¯‡ |
|-------|------|-------|
| [åè®®å¤„ç†æ¨¡å—](01-åè®®å¤„ç†æ¨¡å—.md) | [è¿”å›ç›®å½•](README.md) | [æ‰“åŒ…ä¸éƒ¨ç½²](03-æ‰“åŒ…ä¸éƒ¨ç½².md) |
