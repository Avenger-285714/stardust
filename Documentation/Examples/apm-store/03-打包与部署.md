# 打包与部署

> Debian 包结构、控制文件与安装后配置

## 模块概览

### 文件位置

| 文件 | 路径 | 描述 |
|------|------|------|
| control | `src/DEBIAN/control` | 包元数据定义 |
| postinst | `src/DEBIAN/postinst` | 安装后执行脚本 |

### 功能职责

- 定义软件包的元信息（名称、版本、依赖等）
- 安装后注册 apmstore:// 协议处理器
- 配置 MIME 类型数据库

### 模块关系图

```mermaid
graph TB
    subgraph "Debian 包结构"
        DEBIAN[DEBIAN/]
        Control[control<br/>包元数据]
        Postinst[postinst<br/>安装后脚本]
        
        USR[usr/]
        Bin[bin/<br/>可执行文件]
        Share[share/<br/>共享资源]
    end

    subgraph "安装流程"
        Dpkg[dpkg -i]
        Extract[解压文件]
        RunPostinst[执行 postinst]
        RegisterMIME[注册 MIME 类型]
    end

    DEBIAN --> Control
    DEBIAN --> Postinst
    USR --> Bin
    USR --> Share

    Dpkg --> Extract
    Extract --> RunPostinst
    RunPostinst --> RegisterMIME
```

## 包控制文件 (control)

### 文件内容

**文件路径**: `src/DEBIAN/control`

```plaintext
Package: apm-store
Version: 0.0.2
Priority: optional
Architecture: all
Section: misc
Source: amber-ce
Maintainer: shenmo <shenmo@spark-app.store>
Installed-Size: 200
Depends: apm,zenity
Conflicts: ace-host-integration
Homepage: https://gitee.com/amber-ce/amber-pm/
Description: store for APM
```

### 字段说明

| 字段 | 值 | 说明 |
|------|-----|------|
| **Package** | `apm-store` | 包名称 |
| **Version** | `0.0.2` | 版本号 |
| **Priority** | `optional` | 优先级（可选包） |
| **Architecture** | `all` | 架构无关（纯脚本） |
| **Section** | `misc` | 分类：杂项 |
| **Source** | `amber-ce` | 源包名 |
| **Maintainer** | `shenmo <shenmo@spark-app.store>` | 维护者 |
| **Installed-Size** | `200` | 安装大小（KB） |
| **Depends** | `apm,zenity` | 运行时依赖 |
| **Conflicts** | `ace-host-integration` | 冲突包 |
| **Homepage** | `https://gitee.com/amber-ce/amber-pm/` | 项目主页 |
| **Description** | `store for APM` | 包描述 |

### 依赖关系图

```mermaid
graph LR
    subgraph "apm-store 依赖"
        APMStore[apm-store<br/>v0.0.2]
        APM[apm<br/>包管理器]
        Zenity[zenity<br/>GTK 对话框]
    end

    subgraph "冲突包"
        ACE[ace-host-integration]
    end

    APMStore -->|依赖| APM
    APMStore -->|依赖| Zenity
    APMStore -.->|冲突| ACE
```

## 安装后脚本 (postinst)

### 文件内容

**文件路径**: `src/DEBIAN/postinst`

```bash
#!/bin/bash
xdg-mime default apm-store-handler.desktop x-scheme-handler/apmstore
update-mime-database /usr/share/mime || true
```

### 执行步骤说明

| 步骤 | 命令 | 功能 |
|------|------|------|
| 1 | `xdg-mime default` | 将 `apm-store-handler.desktop` 设为 `apmstore://` 协议的默认处理器 |
| 2 | `update-mime-database` | 更新 MIME 数据库，使协议注册生效 |

### 流程图

```mermaid
flowchart TD
    Start([postinst 开始]) --> RegisterHandler[注册协议处理器]
    
    RegisterHandler --> |xdg-mime default| SetDefault["设置 apm-store-handler.desktop<br/>为 apmstore:// 默认处理器"]
    
    SetDefault --> UpdateMIME[更新 MIME 数据库]
    UpdateMIME --> |update-mime-database| RefreshDB[刷新 /usr/share/mime]
    
    RefreshDB --> End([结束])
```

## 完整包结构

```mermaid
graph TB
    subgraph "src/ (包根目录)"
        DEBIAN["DEBIAN/"]
        USR["usr/"]
    end

    subgraph "DEBIAN/ (控制目录)"
        Control["control<br/><i>包元数据</i>"]
        Postinst["postinst<br/><i>安装后脚本</i>"]
    end

    subgraph "usr/bin/ (可执行文件)"
        ApmInstaller["apm-installer"]
        ApmStore["apm-store"]
        ApmHandler["apm-store-handler"]
        ApmUpdater["apm-update-tool"]
    end

    subgraph "usr/share/ (共享资源)"
        Apps["applications/<br/><i>桌面入口</i>"]
        Icons["icons/<br/><i>图标</i>"]
        Polkit["polkit-1/<br/><i>权限策略</i>"]
    end

    DEBIAN --> Control
    DEBIAN --> Postinst
    
    USR --> Bin["bin/"]
    USR --> Share["share/"]
    
    Bin --> ApmInstaller
    Bin --> ApmStore
    Bin --> ApmHandler
    Bin --> ApmUpdater
    
    Share --> Apps
    Share --> Icons
    Share --> Polkit
```

## 构建与安装

### 构建 Debian 包

```bash
# 进入源码目录
cd Examples/apm-store/src

# 构建 .deb 包
dpkg-deb --build . ../apm-store_0.0.2_all.deb
```

### 安装包

```bash
# 安装
sudo dpkg -i apm-store_0.0.2_all.deb

# 安装缺失依赖
sudo apt-get install -f
```

### 卸载包

```bash
sudo dpkg -r apm-store
```

### 构建流程时序图

```mermaid
sequenceDiagram
    participant Dev as 开发者
    participant Dpkg as dpkg-deb
    participant FS as 文件系统
    participant APT as APT

    Dev->>Dpkg: dpkg-deb --build src/
    activate Dpkg
    Dpkg->>FS: 读取 DEBIAN/control
    Dpkg->>FS: 打包 usr/ 目录
    Dpkg->>FS: 生成 .deb 文件
    deactivate Dpkg
    Dpkg-->>Dev: apm-store_0.0.2_all.deb

    Dev->>Dpkg: dpkg -i apm-store.deb
    activate Dpkg
    Dpkg->>FS: 解压文件到系统
    Dpkg->>FS: 执行 postinst
    Note over FS: 注册 apmstore:// 协议
    deactivate Dpkg

    Dev->>APT: apt-get install -f
    activate APT
    APT->>APT: 检查依赖
    APT->>APT: 安装 apm, zenity
    deactivate APT
```

## 安装状态图

```mermaid
stateDiagram-v2
    [*] --> 未安装
    
    未安装 --> 解压中 : dpkg -i
    解压中 --> 配置中 : 文件解压完成
    配置中 --> 已安装 : postinst 执行成功
    配置中 --> 半配置 : postinst 失败
    
    已安装 --> 移除中 : dpkg -r
    移除中 --> 未安装 : 移除完成
    
    半配置 --> 配置中 : dpkg --configure
    半配置 --> 移除中 : dpkg -r --force
```

## 安装路径对照表

| 源路径 | 安装路径 | 权限 |
|-------|---------|------|
| `src/usr/bin/apm-installer` | `/usr/bin/apm-installer` | 755 |
| `src/usr/bin/apm-store` | `/usr/bin/apm-store` | 755 |
| `src/usr/bin/apm-store-handler` | `/usr/bin/apm-store-handler` | 755 |
| `src/usr/bin/apm-update-tool` | `/usr/bin/apm-update-tool` | 755 |
| `src/usr/share/applications/*.desktop` | `/usr/share/applications/` | 644 |
| `src/usr/share/icons/apm-store.png` | `/usr/share/icons/apm-store.png` | 644 |
| `src/usr/share/polkit-1/actions/*.policy` | `/usr/share/polkit-1/actions/` | 644 |

## 导航链接

| 上一篇 | 目录 | 下一篇 |
|-------|------|-------|
| [核心工具模块](02-核心工具模块.md) | [返回目录](README.md) | [桌面集成](04-桌面集成.md) |
