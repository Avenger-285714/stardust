# 协议处理模块

> apm-store-handler - apmstore:// URL 协议解析与路由

## 模块概览

### 文件位置

| 文件 | 路径 | 描述 |
|------|------|------|
| apm-store-handler | `src/usr/bin/apm-store-handler` | 协议处理器主程序 |
| apm-store-handler.desktop | `src/usr/share/applications/apm-store-handler.desktop` | 协议注册桌面文件 |

### 功能职责

协议处理模块负责：
1. 接收并解析 `apmstore://` 协议 URL
2. 提取 URL 中的路径和查询参数
3. 根据不同的操作类型路由到对应的工具
4. 提供输入验证和安全过滤

### 模块关系图

```mermaid
graph LR
    subgraph "输入源"
        Browser[浏览器]
        Terminal[终端]
    end

    subgraph "协议处理模块"
        Handler[apm-store-handler]
        Parser[URL 解析器]
        Router[路由分发器]
        Validator[输入验证器]
    end

    subgraph "目标工具"
        Installer[apm-installer]
        Updater[apm-update-tool]
    end

    Browser -->|apmstore://| Handler
    Terminal -->|apmstore://| Handler
    Handler --> Parser
    Parser --> Router
    Router --> Validator
    Validator -->|install| Installer
    Validator -->|action| Updater
```

## 函数定义

### 核心函数

```bash
# 日志输出函数
log() { echo "[apm-store-handler] $*" >&2; }

# URL 解码函数（纯 bash 实现）
url_decode() {
  local encoded_str="$1"
  encoded_str="${encoded_str//+/ }"     # 处理 + 号
  printf '%b' "${encoded_str//%/\\x}"   # 处理 %XX 序列
}

# 查询参数解析函数
get_query_val() {
  local key="$1"
  local q="$query"
  # 遍历键值对查找匹配项
  ...
}
```

### 函数关系图

```mermaid
classDiagram
    class Handler {
        +main()
        +log(message)
        +url_decode(encoded_str)
        +get_query_val(key)
    }
    
    class URLParser {
        +parse_protocol(url)
        +split_path_query(url)
    }
    
    class Router {
        +route_install(pkg)
        +route_action(cmd)
        +route_legacy(path)
    }
    
    Handler --> URLParser : 使用
    Handler --> Router : 调用
```

## 核心实现

### URL 解析流程

**文件路径**: `src/usr/bin/apm-store-handler`

```bash
# 先去掉前缀 apmstore://
url_no_proto="${URL#apmstore://}"

# 将 path 与 query 分离
path="${url_no_proto%%\?*}"
query="${url_no_proto#*\?}"
if [ "$query" = "$url_no_proto" ]; then
  query=""
fi
```

#### 伪代码描述

```
输入: URL = "apmstore://install?pkg=foo"

1. 移除协议前缀 "apmstore://"
   -> "install?pkg=foo"

2. 分离路径和查询字符串
   path = "install"
   query = "pkg=foo"

3. 解析查询参数
   pkg = url_decode("foo") -> "foo"

4. 路由到对应处理器
   -> 调用 apm-installer --install foo
```

### 路由分发实现

| 路径模式 | 查询参数 | 目标工具 | 操作 |
|---------|---------|---------|------|
| `install` | `pkg=<name>` | apm-installer | `--install <name>` |
| `install/<name>` | - | apm-installer | `--install <name>` (兼容模式) |
| `action` | `cmd=update` | apm-update-tool | 检查更新 |
| `action` | `cmd=list` | apm-installer | `--list` |

### 安全验证

**文件路径**: `src/usr/bin/apm-store-handler`

```bash
# 仅允许安全字符，避免命令注入
if [[ ! "$pkg" =~ ^[A-Za-z0-9_.:-]+$ ]]; then
  log "非法的包名内容，拒绝执行: '$pkg'"
  exit 4
fi
```

#### 允许字符表

| 字符类型 | 允许的字符 | 示例 |
|---------|-----------|------|
| 字母 | A-Z, a-z | `PackageName` |
| 数字 | 0-9 | `package123` |
| 特殊符号 | `_` `.` `:` `-` | `pkg-name_v1.0:arch` |

## 流程图

### 业务流程图

```mermaid
flowchart TD
    Start([开始]) --> CheckURL{URL 是否为空?}
    CheckURL -->|是| Error1[/错误: 无 URL 参数/]
    CheckURL -->|否| ParseURL[解析 URL]
    
    ParseURL --> ExtractPath[提取路径]
    ExtractPath --> ExtractQuery[提取查询参数]
    
    ExtractQuery --> RouteSwitch{路径匹配}
    
    RouteSwitch -->|install| GetPkg[获取 pkg 参数]
    RouteSwitch -->|action| GetCmd[获取 cmd 参数]
    RouteSwitch -->|install/xxx| LegacyPkg[从路径提取包名]
    RouteSwitch -->|其他| Error2[/错误: 无法识别的路径/]
    
    GetPkg --> ValidatePkg{验证包名}
    ValidatePkg -->|无效| Error3[/错误: 非法包名/]
    ValidatePkg -->|有效| CallInstaller[调用 apm-installer --install]
    
    GetCmd --> CmdSwitch{cmd 类型}
    CmdSwitch -->|update| CallUpdater[调用 apm-update-tool]
    CmdSwitch -->|list| CallList[调用 apm-installer --list]
    CmdSwitch -->|其他| Error4[/错误: 未知 cmd/]
    
    LegacyPkg --> CallInstaller
    
    CallInstaller --> End([结束])
    CallUpdater --> End
    CallList --> End
    
    Error1 --> Exit2[退出码 2]
    Error2 --> Exit11[退出码 11]
    Error3 --> Exit4[退出码 4]
    Error4 --> Exit9[退出码 9]
```

### 时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Browser as 浏览器
    participant XDG as XDG MIME
    participant Handler as apm-store-handler
    participant Installer as apm-installer

    User->>Browser: 点击 apmstore://install?pkg=foo
    Browser->>XDG: 查找协议处理器
    XDG->>Handler: 执行 apm-store-handler "apmstore://install?pkg=foo"
    
    activate Handler
    Handler->>Handler: 解析 URL
    Note over Handler: url_no_proto = "install?pkg=foo"
    Handler->>Handler: 分离 path 和 query
    Note over Handler: path = "install"<br/>query = "pkg=foo"
    Handler->>Handler: 获取 pkg 参数
    Note over Handler: pkg = "foo"
    Handler->>Handler: 验证包名格式
    Handler->>Installer: 执行 apm-installer --install foo
    deactivate Handler
    
    activate Installer
    Installer-->>User: 安装界面
    deactivate Installer
```

### 状态图

```mermaid
stateDiagram-v2
    [*] --> 等待输入
    
    等待输入 --> 解析URL : 收到 URL
    等待输入 --> 错误_无输入 : URL 为空
    
    解析URL --> 路由分发 : 解析成功
    
    路由分发 --> 安装流程 : path = install
    路由分发 --> 动作流程 : path = action
    路由分发 --> 兼容模式 : path = install/xxx
    路由分发 --> 错误_未知路径 : 其他
    
    安装流程 --> 验证包名 : 获取 pkg 参数
    验证包名 --> 调用安装器 : 包名有效
    验证包名 --> 错误_非法包名 : 包名无效
    
    动作流程 --> 调用更新器 : cmd = update
    动作流程 --> 调用列表 : cmd = list
    动作流程 --> 错误_未知命令 : 其他
    
    兼容模式 --> 调用安装器 : 提取包名
    
    调用安装器 --> [*]
    调用更新器 --> [*]
    调用列表 --> [*]
    
    错误_无输入 --> [*]
    错误_未知路径 --> [*]
    错误_非法包名 --> [*]
    错误_未知命令 --> [*]
```

## 退出码说明

| 退出码 | 含义 |
|-------|------|
| 0 | 成功 |
| 2 | 未传入 URL 参数 |
| 3 | install 操作缺少 pkg 参数 |
| 4 | 包名含有非法字符 |
| 5 | apm-installer 未找到 |
| 6 | action 操作缺少 cmd 参数 |
| 7 | apm-update-tool 未找到 |
| 8 | apm-installer 未找到 (list) |
| 9 | 未知的 action cmd |
| 10 | apm-installer 未找到 (兼容模式) |
| 11 | 无法识别的路径 |

## 导航链接

| 上一篇 | 目录 | 下一篇 |
|-------|------|-------|
| - | [返回目录](README.md) | [核心工具模块](02-核心工具模块.md) |
