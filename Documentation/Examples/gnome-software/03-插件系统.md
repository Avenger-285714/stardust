# 03 - 插件系统

## 模块概览

### 文件位置

- 插件目录: `Examples/gnome-software/plugins/`
- 核心插件: `plugins/core/`
- 第三方插件构建配置: `plugins/meson.build`

### 功能职责

插件系统是 GNOME Software 的核心扩展机制，通过插件可以：

- 支持不同的软件包格式 (Flatpak, Snap, DEB, RPM)
- 接入不同的软件源和仓库
- 提供应用元数据 (AppStream)
- 处理固件更新
- 实现发行版特定功能

### 模块关系图

```mermaid
graph TB
    subgraph "插件加载器"
        LOADER[GsPluginLoader]
        SCANNER[插件扫描器]
        SORTER[拓扑排序]
    end
    
    subgraph "核心插件 (core/)"
        APPSTREAM[gs-plugin-appstream<br/>AppStream 元数据]
        ICONS[gs-plugin-icons<br/>图标处理]
        OSREL[gs-plugin-os-release<br/>系统信息]
        PROV[gs-plugin-provenance<br/>来源标识]
        BLOCKLIST[gs-plugin-hardcoded-blocklist<br/>黑名单]
        GENERIC[gs-plugin-generic-updates<br/>通用更新]
    end
    
    subgraph "包管理插件"
        FLATPAK[gs-plugin-flatpak]
        PACKAGEKIT[gs-plugin-packagekit]
        SNAP[gs-plugin-snap]
        DPKG[gs-plugin-dpkg]
    end
    
    subgraph "其他插件"
        FWUPD[gs-plugin-fwupd<br/>固件更新]
        REPOS[gs-plugin-repos<br/>软件源管理]
        MODALIAS[gs-plugin-modalias<br/>硬件驱动]
        EPIPHANY[gs-plugin-epiphany<br/>Web 应用]
    end
    
    LOADER --> SCANNER
    SCANNER --> SORTER
    
    SORTER --> APPSTREAM
    SORTER --> ICONS
    SORTER --> OSREL
    SORTER --> PROV
    SORTER --> BLOCKLIST
    SORTER --> GENERIC
    
    SORTER --> FLATPAK
    SORTER --> PACKAGEKIT
    SORTER --> SNAP
    SORTER --> DPKG
    
    SORTER --> FWUPD
    SORTER --> REPOS
    SORTER --> MODALIAS
    SORTER --> EPIPHANY
```

## 插件接口

### GsPlugin 虚函数表

```c
// 文件: lib/gs-plugin.h

struct _GsPluginClass {
    GObjectClass parent_class;
    
    // === 生命周期管理 ===
    
    // 插件初始化
    void (*setup_async) (GsPlugin *plugin,
                         GCancellable *cancellable,
                         GAsyncReadyCallback callback,
                         gpointer user_data);
    gboolean (*setup_finish) (GsPlugin *plugin,
                              GAsyncResult *result,
                              GError **error);
    
    // 插件关闭
    void (*shutdown_async) (GsPlugin *plugin, ...);
    gboolean (*shutdown_finish) (GsPlugin *plugin, ...);
    
    // === 应用发现 ===
    
    // 列出应用
    void (*list_apps_async) (GsPlugin *plugin,
                             GsAppQuery *query,
                             GsPluginListAppsFlags flags,
                             GCancellable *cancellable,
                             GAsyncReadyCallback callback,
                             gpointer user_data);
    GsAppList *(*list_apps_finish) (GsPlugin *plugin,
                                    GAsyncResult *result,
                                    GError **error);
    
    // 细化应用信息
    void (*refine_async) (GsPlugin *plugin,
                          GsAppList *list,
                          GsPluginRefineFlags flags,
                          GsPluginRefineRequireFlags require_flags,
                          GCancellable *cancellable,
                          GAsyncReadyCallback callback,
                          gpointer user_data);
    gboolean (*refine_finish) (GsPlugin *plugin,
                               GAsyncResult *result,
                               GError **error);
    
    // === 应用操作 ===
    
    // 安装应用
    void (*install_apps_async) (GsPlugin *plugin,
                                GsAppList *apps,
                                GsPluginInstallAppsFlags flags,
                                GsPluginProgressCallback progress_cb,
                                gpointer progress_data,
                                GCancellable *cancellable,
                                GAsyncReadyCallback callback,
                                gpointer user_data);
    gboolean (*install_apps_finish) (GsPlugin *plugin,
                                     GAsyncResult *result,
                                     GError **error);
    
    // 卸载应用
    void (*uninstall_apps_async) (GsPlugin *plugin, ...);
    gboolean (*uninstall_apps_finish) (GsPlugin *plugin, ...);
    
    // 更新应用
    void (*update_apps_async) (GsPlugin *plugin, ...);
    gboolean (*update_apps_finish) (GsPlugin *plugin, ...);
    
    // === 其他操作 ===
    
    // 刷新元数据
    void (*refresh_metadata_async) (GsPlugin *plugin, ...);
    
    // 分类细化
    void (*refine_categories_async) (GsPlugin *plugin, ...);
    
    // 文件转应用
    void (*file_to_app_async) (GsPlugin *plugin, GFile *file, ...);
    
    // URL 转应用
    void (*url_to_app_async) (GsPlugin *plugin, const gchar *url, ...);
    
    // 启动应用
    void (*launch_async) (GsPlugin *plugin, GsApp *app, ...);
    
    // 仓库管理
    void (*install_repository_async) (GsPlugin *plugin, GsApp *repo, ...);
    void (*remove_repository_async) (GsPlugin *plugin, GsApp *repo, ...);
    void (*enable_repository_async) (GsPlugin *plugin, GsApp *repo, ...);
    void (*disable_repository_async) (GsPlugin *plugin, GsApp *repo, ...);
    
    // 发行版升级
    void (*list_distro_upgrades_async) (GsPlugin *plugin, ...);
    void (*download_upgrade_async) (GsPlugin *plugin, GsApp *app, ...);
    void (*trigger_upgrade_async) (GsPlugin *plugin, GsApp *app, ...);
    
    gpointer padding[23];
};
```

### 细化标志

```c
// 文件: lib/gs-plugin-types.h

typedef enum {
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_NONE           = 0,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_ID             = 1 << 0,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_LICENSE        = 1 << 1,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_URL            = 1 << 2,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_DESCRIPTION    = 1 << 3,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_SIZE           = 1 << 4,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_RATING         = 1 << 5,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_VERSION        = 1 << 6,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_HISTORY        = 1 << 7,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_SETUP_ACTION   = 1 << 8,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_UPDATE_DETAILS = 1 << 9,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_ORIGIN         = 1 << 10,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_ORIGIN_UI      = 1 << 11,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_PERMISSIONS    = 1 << 12,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_SCREENSHOTS    = 1 << 13,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_CATEGORIES     = 1 << 14,
    GS_PLUGIN_REFINE_REQUIRE_FLAGS_ICON           = 1 << 15,
} GsPluginRefineRequireFlags;
```

## 插件实现模式

### 插件模板

```c
// 文件: plugins/example/gs-plugin-example.c

#include <gnome-software.h>

struct _GsPluginExample {
    GsPlugin parent;
    
    // 私有数据
    SomeClient *client;
    GHashTable *cache;
};

G_DEFINE_TYPE (GsPluginExample, gs_plugin_example, GS_TYPE_PLUGIN)

static void
gs_plugin_example_init (GsPluginExample *self)
{
    GsPlugin *plugin = GS_PLUGIN (self);
    
    // 设置插件名称
    gs_plugin_set_name (plugin, "example");
    
    // 添加规则
    gs_plugin_add_rule (plugin, GS_PLUGIN_RULE_RUN_AFTER, "appstream");
}

static void
gs_plugin_example_setup_async (GsPlugin *plugin,
                               GCancellable *cancellable,
                               GAsyncReadyCallback callback,
                               gpointer user_data)
{
    GsPluginExample *self = GS_PLUGIN_EXAMPLE (plugin);
    g_autoptr(GTask) task = g_task_new (plugin, cancellable, callback, user_data);
    
    // 初始化资源
    self->client = some_client_new ();
    self->cache = g_hash_table_new_full (g_str_hash, g_str_equal, 
                                          g_free, g_object_unref);
    
    g_task_return_boolean (task, TRUE);
}

static gboolean
gs_plugin_example_setup_finish (GsPlugin *plugin,
                                GAsyncResult *result,
                                GError **error)
{
    return g_task_propagate_boolean (G_TASK (result), error);
}

static void
gs_plugin_example_class_init (GsPluginExampleClass *klass)
{
    GsPluginClass *plugin_class = GS_PLUGIN_CLASS (klass);
    
    plugin_class->setup_async = gs_plugin_example_setup_async;
    plugin_class->setup_finish = gs_plugin_example_setup_finish;
    // 实现其他虚函数...
}
```

### 插件执行流程

```mermaid
sequenceDiagram
    participant Loader as GsPluginLoader
    participant Job as GsPluginJob
    participant Plugin1 as 插件A
    participant Plugin2 as 插件B
    participant Plugin3 as 插件C

    Loader->>Job: run_async()
    
    Note over Job: 按拓扑顺序执行
    
    Job->>Plugin1: list_apps_async()
    Plugin1-->>Job: GsAppList (apps: A, B)
    
    Job->>Plugin2: list_apps_async()
    Plugin2-->>Job: GsAppList (apps: C, D)
    
    Job->>Plugin3: list_apps_async()
    Plugin3-->>Job: GsAppList (apps: E)
    
    Job->>Job: 合并列表 (A, B, C, D, E)
    
    Note over Job: 细化阶段
    
    Job->>Plugin1: refine_async(list)
    Plugin1-->>Job: 添加详细信息
    
    Job->>Plugin2: refine_async(list)
    Plugin2-->>Job: 添加详细信息
    
    Job->>Plugin3: refine_async(list)
    Plugin3-->>Job: 添加详细信息
    
    Job-->>Loader: 完整 GsAppList
```

## 核心插件详解

### AppStream 插件

```c
// 文件: plugins/core/gs-plugin-appstream.c
// 职责: 加载和解析 AppStream 元数据

struct _GsPluginAppstream {
    GsPlugin parent;
    XbSilo *silo;           // libxmlb 数据库
    GHashTable *components; // 组件缓存
};

// 关键功能:
// - 加载 /usr/share/appdata/*.xml
// - 加载 /var/lib/flatpak/app/.../appdata
// - 解析 AppStream 组件到 GsApp
// - 提供搜索和分类查询
```

### Icons 插件

```c
// 文件: plugins/core/gs-plugin-icons.c
// 职责: 下载和管理应用图标

// 图标处理流程:
// 1. 检查本地缓存
// 2. 从远程 URL 下载
// 3. 缩放到合适大小
// 4. 缓存到本地
```

### Provenance 插件

```c
// 文件: plugins/core/gs-plugin-provenance.c
// 职责: 标识应用来源可信度

// 检查应用是否来自:
// - 官方发行版仓库
// - 已验证的第三方源
// - 未知来源
```

## 包管理插件

### Flatpak 插件架构

```mermaid
graph TB
    subgraph "GsPluginFlatpak"
        PLUGIN[gs-plugin-flatpak.c]
        FLATPAK_MAIN[gs-flatpak.c<br/>核心实现]
        FLATPAK_APP[gs-flatpak-app.c<br/>应用扩展]
        FLATPAK_TX[gs-flatpak-transaction.c<br/>事务处理]
        FLATPAK_UTILS[gs-flatpak-utils.c<br/>工具函数]
    end
    
    subgraph "外部依赖"
        LIBFLATPAK[libflatpak]
        OSTREE[libostree]
    end
    
    PLUGIN --> FLATPAK_MAIN
    FLATPAK_MAIN --> FLATPAK_APP
    FLATPAK_MAIN --> FLATPAK_TX
    FLATPAK_MAIN --> FLATPAK_UTILS
    
    FLATPAK_MAIN --> LIBFLATPAK
    LIBFLATPAK --> OSTREE
```

### Flatpak 安装流程

```mermaid
sequenceDiagram
    participant UI as 用户界面
    participant Plugin as GsPluginFlatpak
    participant GsFlatpak as GsFlatpak
    participant TX as FlatpakTransaction
    participant Daemon as Flatpak System Helper

    UI->>Plugin: install_apps_async()
    Plugin->>GsFlatpak: 选择安装位置
    
    alt 系统安装
        GsFlatpak->>Daemon: 请求权限
        Daemon-->>GsFlatpak: 授权
    else 用户安装
        Note over GsFlatpak: 无需权限
    end
    
    GsFlatpak->>TX: flatpak_transaction_new()
    GsFlatpak->>TX: add_install()
    GsFlatpak->>TX: run()
    
    loop 下载阶段
        TX-->>GsFlatpak: progress_callback()
        GsFlatpak-->>Plugin: 更新进度
        Plugin-->>UI: 显示进度
    end
    
    TX-->>GsFlatpak: 安装完成
    GsFlatpak->>GsFlatpak: 更新 GsApp 状态
    GsFlatpak-->>Plugin: 返回成功
    Plugin-->>UI: 安装完成
```

### PackageKit 插件

```c
// 文件: plugins/packagekit/gs-plugin-packagekit.c

struct _GsPluginPackagekit {
    GsPlugin parent;
    PkTask *task;           // PackageKit 任务
    PkControl *control;     // 守护进程控制
};

// 支持的操作:
// - 搜索包
// - 安装/卸载包
// - 系统更新
// - 依赖解析
// - 事务历史
```

### Snap 插件

```c
// 文件: plugins/snap/gs-plugin-snap.c

struct _GsPluginSnap {
    GsPlugin parent;
    SnapdClient *client;    // snapd 客户端
    GHashTable *store_snaps; // 商店缓存
};

// 特殊处理:
// - 通道 (stable, beta, edge)
// - 连接 (plugs/slots)
// - 权限管理
```

## 插件规则系统

### 规则类型

| 规则 | 说明 | 示例 |
|------|------|------|
| `RUN_AFTER` | 在指定插件之后运行 | flatpak → appstream |
| `RUN_BEFORE` | 在指定插件之前运行 | icons → details |
| `CONFLICTS` | 与指定插件冲突 | snap → flatpak (同一应用) |
| `BETTER_THAN` | 优先级高于指定插件 | flatpak → packagekit |

### 规则示例

```c
// Flatpak 插件规则
static void
gs_plugin_flatpak_init (GsPluginFlatpak *self)
{
    GsPlugin *plugin = GS_PLUGIN (self);
    
    // 在 AppStream 之后运行，需要元数据
    gs_plugin_add_rule (plugin, GS_PLUGIN_RULE_RUN_AFTER, "appstream");
    
    // 在图标插件之后运行
    gs_plugin_add_rule (plugin, GS_PLUGIN_RULE_RUN_AFTER, "icons");
    
    // Flatpak 优先于 PackageKit (同一应用)
    gs_plugin_add_rule (plugin, GS_PLUGIN_RULE_BETTER_THAN, "packagekit");
}
```

### 依赖图解析

```mermaid
graph LR
    subgraph "解析顺序"
        OS[os-release] --> APPSTREAM[appstream]
        APPSTREAM --> ICONS[icons]
        APPSTREAM --> FLATPAK[flatpak]
        APPSTREAM --> PACKAGEKIT[packagekit]
        ICONS --> FLATPAK
        ICONS --> PACKAGEKIT
        FLATPAK --> GENERIC[generic-updates]
        PACKAGEKIT --> GENERIC
    end
    
    style OS fill:#90EE90
    style GENERIC fill:#FFB6C1
```

## 插件缓存

### 缓存 API

```c
// 查找缓存
GsApp *gs_plugin_cache_lookup (GsPlugin *plugin, const gchar *key);

// 添加到缓存
void gs_plugin_cache_add (GsPlugin *plugin, const gchar *key, GsApp *app);

// 移除缓存
void gs_plugin_cache_remove (GsPlugin *plugin, const gchar *key);

// 清空缓存
void gs_plugin_cache_invalidate (GsPlugin *plugin);

// 列出所有缓存
GsAppList *gs_plugin_list_cached (GsPlugin *plugin);
```

### 缓存键格式

```
{plugin_name}:{unique_id}

示例:
flatpak:user/flatpak/*/org.mozilla.Firefox/stable
packagekit:installed:firefox
snap:installed:firefox
```

## 事件系统

### GsPluginEvent

```c
// 文件: lib/gs-plugin-event.h

typedef enum {
    GS_PLUGIN_EVENT_FLAG_NONE       = 0,
    GS_PLUGIN_EVENT_FLAG_WARNING    = 1 << 0,
    GS_PLUGIN_EVENT_FLAG_INTERACTIVE = 1 << 1,
} GsPluginEventFlags;

// 创建事件
GsPluginEvent *gs_plugin_event_new (void);

// 设置信息
void gs_plugin_event_set_app (GsPluginEvent *event, GsApp *app);
void gs_plugin_event_set_error (GsPluginEvent *event, const GError *error);
void gs_plugin_event_add_flag (GsPluginEvent *event, GsPluginEventFlags flag);

// 上报事件
void gs_plugin_report_event (GsPlugin *plugin, GsPluginEvent *event);
```

### 事件处理流程

```mermaid
flowchart TD
    A[插件遇到错误] --> B{错误类型}
    
    B -->|网络错误| C[创建 GsPluginEvent]
    B -->|权限错误| C
    B -->|依赖错误| C
    
    C --> D[设置错误详情]
    D --> E[设置相关应用]
    E --> F[gs_plugin_report_event]
    
    F --> G[GsPluginLoader 接收]
    G --> H{是否交互式}
    
    H -->|是| I[显示错误对话框]
    H -->|否| J[记录日志]
    
    I --> K[用户确认]
    J --> L[继续执行]
```

---

**导航**
- 上一篇：[02-核心库.md](02-核心库.md)
- 下一篇：[04-任务调度.md](04-任务调度.md)
- [返回目录](README.md)
