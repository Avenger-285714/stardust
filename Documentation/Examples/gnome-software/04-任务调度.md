# 04 - 任务调度

## 模块概览

### 文件位置

- 基类: `lib/gs-plugin-job.c/h`
- 任务管理器: `lib/gs-job-manager.c/h`
- 具体任务实现: `lib/gs-plugin-job-*.c/h`

### 功能职责

任务调度模块负责管理 GNOME Software 中的所有异步操作，包括：

- 应用搜索和列表查询
- 应用安装、卸载和更新
- 元数据刷新
- 发行版升级
- 仓库管理

### 模块关系图

```mermaid
graph TB
    subgraph "任务管理"
        JOBMGR[GsJobManager<br/>任务管理器]
        PENDING[待处理队列]
        ACTIVE[活动任务集]
    end
    
    subgraph "任务基类"
        JOB[GsPluginJob<br/>任务基类]
    end
    
    subgraph "查询任务"
        LIST_APPS[GsPluginJobListApps<br/>列出应用]
        LIST_CAT[GsPluginJobListCategories<br/>列出分类]
        LIST_UPGRADE[GsPluginJobListDistroUpgrades<br/>列出升级]
        REFINE[GsPluginJobRefine<br/>细化信息]
    end
    
    subgraph "操作任务"
        INSTALL[GsPluginJobInstallApps<br/>安装应用]
        UNINSTALL[GsPluginJobUninstallApps<br/>卸载应用]
        UPDATE[GsPluginJobUpdateApps<br/>更新应用]
        LAUNCH[GsPluginJobLaunch<br/>启动应用]
    end
    
    subgraph "其他任务"
        REFRESH[GsPluginJobRefreshMetadata<br/>刷新元数据]
        FILE2APP[GsPluginJobFileToApp<br/>文件转应用]
        URL2APP[GsPluginJobUrlToApp<br/>URL转应用]
        REPO[GsPluginJobManageRepository<br/>仓库管理]
    end
    
    JOBMGR --> PENDING
    JOBMGR --> ACTIVE
    ACTIVE --> JOB
    
    JOB <|-- LIST_APPS
    JOB <|-- LIST_CAT
    JOB <|-- LIST_UPGRADE
    JOB <|-- REFINE
    
    JOB <|-- INSTALL
    JOB <|-- UNINSTALL
    JOB <|-- UPDATE
    JOB <|-- LAUNCH
    
    JOB <|-- REFRESH
    JOB <|-- FILE2APP
    JOB <|-- URL2APP
    JOB <|-- REPO
```

## GsPluginJob - 任务基类

### 类定义

```c
// 文件: lib/gs-plugin-job.h

#define GS_TYPE_PLUGIN_JOB (gs_plugin_job_get_type ())
G_DECLARE_DERIVABLE_TYPE (GsPluginJob, gs_plugin_job, GS, PLUGIN_JOB, GObject)

struct _GsPluginJobClass
{
    GObjectClass parent_class;

    // 异步执行任务
    void (*run_async) (GsPluginJob         *self,
                       GsPluginLoader      *plugin_loader,
                       GCancellable        *cancellable,
                       GAsyncReadyCallback  callback,
                       gpointer             user_data);
    
    // 完成任务
    gboolean (*run_finish) (GsPluginJob   *self,
                            GAsyncResult  *result,
                            GError       **error);
    
    // 是否交互式
    gboolean (*get_interactive) (GsPluginJob *self);
};
```

### 任务继承图

```mermaid
classDiagram
    class GsPluginJob {
        <<abstract>>
        +run_async(loader, cancellable, callback)
        +run_finish(result) : bool
        +get_interactive() : bool
        +emit_event(plugin, event)
    }
    
    class GsPluginJobListApps {
        -GsAppQuery* query
        -GsAppList* result_list
        +get_result_list() : GsAppList
    }
    
    class GsPluginJobRefine {
        -GsAppList* apps
        -GsPluginRefineRequireFlags flags
    }
    
    class GsPluginJobInstallApps {
        -GsAppList* apps
        -GsPluginInstallAppsFlags flags
        +set_progress_callback()
    }
    
    class GsPluginJobUpdateApps {
        -GsAppList* apps
        -GsPluginUpdateAppsFlags flags
    }
    
    class GsPluginJobUninstallApps {
        -GsAppList* apps
    }
    
    class GsPluginJobRefreshMetadata {
        -guint64 cache_age_secs
    }
    
    GsPluginJob <|-- GsPluginJobListApps
    GsPluginJob <|-- GsPluginJobRefine
    GsPluginJob <|-- GsPluginJobInstallApps
    GsPluginJob <|-- GsPluginJobUpdateApps
    GsPluginJob <|-- GsPluginJobUninstallApps
    GsPluginJob <|-- GsPluginJobRefreshMetadata
```

## 任务类型详解

### GsPluginJobListApps

```c
// 文件: lib/gs-plugin-job-list-apps.h

// 创建列表任务
GsPluginJob *gs_plugin_job_list_apps_new (GsAppQuery *query,
                                          GsPluginListAppsFlags flags);

// 获取结果
GsAppList *gs_plugin_job_list_apps_get_result_list (GsPluginJobListApps *self);
```

#### 查询条件 (GsAppQuery)

```c
// 文件: lib/gs-app-query.h

// 创建查询
GsAppQuery *gs_app_query_new (const gchar *first_property, ...);

// 查询属性
typedef enum {
    // 搜索
    "keywords",           // 搜索关键词 (gchar**)
    "provides-files",     // 提供的文件
    
    // 过滤
    "is-installed",       // 是否已安装
    "is-source",          // 是否为软件源
    "is-curated",         // 是否精选
    
    // 分类
    "category",           // 分类 (GsCategory*)
    
    // 分页
    "max-results",        // 最大结果数
    "sort-func",          // 排序函数
} GsAppQueryProperty;
```

### GsPluginJobRefine

```c
// 文件: lib/gs-plugin-job-refine.h

// 创建细化任务
GsPluginJob *gs_plugin_job_refine_new (GsAppList *apps,
                                       GsPluginRefineFlags flags,
                                       GsPluginRefineRequireFlags require_flags);

// 细化标志
typedef enum {
    GS_PLUGIN_REFINE_FLAGS_NONE            = 0,
    GS_PLUGIN_REFINE_FLAGS_INTERACTIVE     = 1 << 0,  // 交互式操作
    GS_PLUGIN_REFINE_FLAGS_DISABLE_FILTERING = 1 << 1, // 禁用过滤
} GsPluginRefineFlags;
```

### GsPluginJobInstallApps

```c
// 文件: lib/gs-plugin-job-install-apps.h

// 创建安装任务
GsPluginJob *gs_plugin_job_install_apps_new (GsAppList *apps,
                                             GsPluginInstallAppsFlags flags);

// 安装标志
typedef enum {
    GS_PLUGIN_INSTALL_APPS_FLAGS_NONE         = 0,
    GS_PLUGIN_INSTALL_APPS_FLAGS_INTERACTIVE  = 1 << 0,  // 交互式
    GS_PLUGIN_INSTALL_APPS_FLAGS_NO_DOWNLOAD  = 1 << 1,  // 仅安装已下载
    GS_PLUGIN_INSTALL_APPS_FLAGS_NO_APPLY     = 1 << 2,  // 仅下载不安装
} GsPluginInstallAppsFlags;

// 进度回调
typedef void (*GsPluginProgressCallback) (GsApp    *app,
                                          guint     percentage,
                                          gpointer  user_data);
```

### GsPluginJobUpdateApps

```c
// 文件: lib/gs-plugin-job-update-apps.h

// 创建更新任务
GsPluginJob *gs_plugin_job_update_apps_new (GsAppList *apps,
                                            GsPluginUpdateAppsFlags flags);

// 更新标志
typedef enum {
    GS_PLUGIN_UPDATE_APPS_FLAGS_NONE         = 0,
    GS_PLUGIN_UPDATE_APPS_FLAGS_INTERACTIVE  = 1 << 0,
    GS_PLUGIN_UPDATE_APPS_FLAGS_NO_DOWNLOAD  = 1 << 1,
    GS_PLUGIN_UPDATE_APPS_FLAGS_NO_APPLY     = 1 << 2,
} GsPluginUpdateAppsFlags;
```

## GsJobManager - 任务管理器

### 类定义

```c
// 文件: lib/gs-job-manager.h

#define GS_TYPE_JOB_MANAGER (gs_job_manager_get_type ())
G_DECLARE_FINAL_TYPE (GsJobManager, gs_job_manager, GS, JOB_MANAGER, GObject)

// 创建管理器
GsJobManager *gs_job_manager_new (void);

// 添加任务
void gs_job_manager_add_job (GsJobManager *self, GsPluginJob *job);

// 移除任务
void gs_job_manager_remove_job (GsJobManager *self, GsPluginJob *job);

// 获取活动任务
GPtrArray *gs_job_manager_get_pending_jobs (GsJobManager *self);
```

### 任务状态图

```mermaid
stateDiagram-v2
    [*] --> Created: 创建任务
    Created --> Queued: 加入队列
    
    Queued --> Running: 开始执行
    
    Running --> Completed: 执行成功
    Running --> Failed: 执行失败
    Running --> Cancelled: 用户取消
    
    Completed --> [*]
    Failed --> [*]
    Cancelled --> [*]
    
    note right of Running
        可通过 GCancellable 取消
    end note
```

## 任务执行流程

### 搜索应用流程

```mermaid
sequenceDiagram
    participant UI as 用户界面
    participant Shell as GsShell
    participant Loader as GsPluginLoader
    participant Job as GsPluginJobListApps
    participant Plugin as 各插件

    UI->>Shell: 用户输入搜索词
    Shell->>Shell: 创建 GsAppQuery
    
    Shell->>Loader: gs_plugin_loader_job_process_async()
    Loader->>Job: gs_plugin_job_run_async()
    
    par 并行查询各插件
        Job->>Plugin: plugin->list_apps_async(query)
        Note over Plugin: Flatpak 搜索
    and
        Job->>Plugin: plugin->list_apps_async(query)
        Note over Plugin: Snap 搜索
    and
        Job->>Plugin: plugin->list_apps_async(query)
        Note over Plugin: PackageKit 搜索
    end
    
    Plugin-->>Job: 各插件返回 GsAppList
    Job->>Job: 合并结果列表
    Job->>Job: 去重和排序
    
    Job->>Loader: 创建细化任务
    Loader->>Job: refine_async(result_list)
    
    loop 细化每个应用
        Job->>Plugin: refine_async(app)
        Plugin-->>Job: 补充详细信息
    end
    
    Job-->>Loader: run_finish()
    Loader-->>Shell: 返回 GsAppList
    Shell-->>UI: 显示搜索结果
```

### 安装应用流程

```mermaid
sequenceDiagram
    participant UI as 用户界面
    participant Shell as GsShell
    participant Loader as GsPluginLoader
    participant Job as GsPluginJobInstallApps
    participant Plugin as 管理插件
    participant Backend as 后端服务

    UI->>Shell: 点击安装按钮
    Shell->>Shell: 创建安装任务
    
    Shell->>Loader: gs_plugin_loader_job_process_async()
    Loader->>Job: gs_plugin_job_run_async()
    
    Job->>Job: 检查应用管理插件
    Job->>Plugin: install_apps_async(app_list)
    
    Plugin->>Backend: 发起安装请求
    
    loop 安装进度
        Backend-->>Plugin: 进度更新
        Plugin-->>Job: progress_callback(app, percentage)
        Job-->>Loader: 转发进度
        Loader-->>Shell: emit("progress-changed")
        Shell-->>UI: 更新进度条
    end
    
    Backend-->>Plugin: 安装完成
    Plugin->>Plugin: 更新 app->state = INSTALLED
    Plugin-->>Job: 返回成功
    
    Job-->>Loader: run_finish()
    Loader->>Loader: emit("updates-changed")
    Loader-->>Shell: 返回成功
    Shell-->>UI: 显示安装成功
```

### 批量更新流程

```mermaid
flowchart TD
    A[获取可更新列表] --> B[创建更新任务]
    B --> C{检查网络状态}
    
    C -->|离线| D[离线更新模式]
    C -->|在线| E[在线更新模式]
    
    D --> F[下载所有更新]
    F --> G[准备离线安装]
    G --> H[设置重启触发器]
    H --> I[提示用户重启]
    
    E --> J{检查应用类型}
    
    J -->|Flatpak| K[Flatpak 更新]
    J -->|PackageKit| L[PackageKit 更新]
    J -->|Snap| M[Snap 更新]
    J -->|固件| N[fwupd 更新]
    
    K --> O[合并结果]
    L --> O
    M --> O
    N --> O
    
    O --> P{全部成功?}
    P -->|是| Q[显示更新完成]
    P -->|否| R[显示部分失败]
```

## 任务伪代码

### 搜索任务执行

```
函数 gs_plugin_job_list_apps_run_async(job, loader, cancellable, callback):
    query = job->query
    result_list = gs_app_list_new()
    
    # 获取所有启用的插件
    plugins = gs_plugin_loader_get_plugins(loader)
    
    # 创建并行任务
    n_pending = 0
    
    对于每个 plugin 在 plugins 中:
        如果 plugin 没有实现 list_apps_async:
            继续
        
        n_pending++
        
        # 异步调用插件
        plugin->list_apps_async(query, on_plugin_done)
    
    等待所有插件完成...

函数 on_plugin_done(plugin, result):
    plugin_list = plugin->list_apps_finish(result)
    
    # 合并到结果列表
    对于每个 app 在 plugin_list 中:
        gs_app_list_add(result_list, app)
    
    n_pending--
    
    如果 n_pending == 0:
        # 所有插件完成，开始细化
        refine_result_list()
```

### 安装任务执行

```
函数 gs_plugin_job_install_apps_run_async(job, loader, cancellable, callback):
    apps = job->apps
    
    对于每个 app 在 apps 中:
        # 设置安装中状态
        gs_app_set_state(app, GS_APP_STATE_INSTALLING)
        
        # 找到管理插件
        plugin = gs_app_dup_management_plugin(app)
        
        如果 plugin == NULL:
            # 尝试认领应用
            plugin = gs_plugin_loader_find_manager(loader, app)
        
        如果 plugin == NULL:
            报错("没有找到能安装此应用的插件")
            继续
        
        # 调用插件安装
        plugin->install_apps_async(
            [app],
            flags,
            progress_callback,
            cancellable,
            on_install_done
        )

函数 on_install_done(plugin, result):
    success = plugin->install_apps_finish(result)
    
    如果 success:
        gs_app_set_state(app, GS_APP_STATE_INSTALLED)
    否则:
        gs_app_set_state_recover(app)  # 恢复之前状态
        报告错误事件
```

## 取消机制

### GCancellable 集成

```c
// 创建可取消的任务
GCancellable *cancellable = g_cancellable_new ();

// 执行任务
gs_plugin_loader_job_process_async (loader, job, cancellable,
                                     on_complete, user_data);

// 用户取消
g_cancellable_cancel (cancellable);

// 在任务中检查取消
if (g_cancellable_is_cancelled (cancellable)) {
    g_task_return_error_if_cancelled (task);
    return;
}
```

### 取消流程

```mermaid
sequenceDiagram
    participant UI as 用户界面
    participant Job as 任务
    participant Plugin as 插件
    participant Backend as 后端

    UI->>Job: 开始任务
    Job->>Plugin: 调用插件
    Plugin->>Backend: 发起操作
    
    UI->>Job: g_cancellable_cancel()
    
    Job->>Plugin: 传递取消信号
    Plugin->>Backend: 取消操作
    Backend-->>Plugin: 操作已取消
    
    Plugin-->>Job: 返回 G_IO_ERROR_CANCELLED
    Job-->>UI: 任务已取消
```

## 并发控制

### 任务队列

```mermaid
graph LR
    subgraph "任务队列"
        Q1[搜索任务]
        Q2[安装任务1]
        Q3[安装任务2]
        Q4[刷新任务]
    end
    
    subgraph "执行器"
        E1[插件执行线程1]
        E2[插件执行线程2]
    end
    
    Q1 --> E1
    Q2 --> E2
    
    Q3 -.-> |等待| Q2
    Q4 -.-> |等待| Q1
```

### 锁策略

| 资源 | 锁类型 | 说明 |
|------|--------|------|
| 插件缓存 | 读写锁 | 允许并发读取 |
| 应用状态 | 互斥锁 | 状态更新串行 |
| 任务队列 | 互斥锁 | 队列操作串行 |
| D-Bus 连接 | 无锁 | GDBus 线程安全 |

---

**导航**
- 上一篇：[03-插件系统.md](03-插件系统.md)
- 下一篇：[05-用户界面.md](05-用户界面.md)
- [返回目录](README.md)
