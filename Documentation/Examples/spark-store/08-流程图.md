# 08 - 流程图

> 本文档包含 Spark Store 各核心业务流程的 Mermaid 流程图

## 目录

- [应用启动流程](#应用启动流程)
- [应用下载安装流程](#应用下载安装流程)
- [URL 协议处理流程](#url-协议处理流程)
- [主题切换流程](#主题切换流程)
- [页面导航流程](#页面导航流程)
- [搜索流程](#搜索流程)
- [ACE 容器安装流程](#ace-容器安装流程)
- [崩溃处理流程](#崩溃处理流程)
- [单实例控制流程](#单实例控制流程)
- [模块依赖关系](#模块依赖关系)

---

## 应用启动流程

### 完整启动序列

```mermaid
sequenceDiagram
    participant OS as 操作系统
    participant M as main()
    participant U as Utils
    participant D as DataCollector
    participant A as Application
    participant MW as MainWindow
    participant DB as D-Bus
    
    OS->>M: 执行程序
    
    Note over M: 阶段1: 错误处理设置
    M->>M: signal(SIGSEGV, crashHandler)
    
    Note over M: 阶段2: 日志初始化
    M->>U: initLogger()
    U->>U: 创建日志目录
    U->>U: 设置消息处理器
    
    Note over M: 阶段3: 配置初始化
    M->>A: checkAppConfigLocation()
    A->>A: 创建 ~/.config/spark-store/
    M->>U: initConfig()
    U->>U: 读取/创建配置文件
    
    Note over M: 阶段4: 数据收集
    M->>D: new DataCollectorAndUploader()
    D->>D: 收集系统信息
    D->>D: 异步上传统计
    
    Note over M: 阶段5: 平台适配
    M->>U: setQPAPlatform()
    U->>U: 检测 Wayland/X11
    U->>U: 设置环境变量
    
    Note over M: 阶段6: 应用创建
    M->>A: new Application()
    A->>A: 加载翻译
    A->>A: setSingleInstance()
    
    alt 已有实例运行
        A->>DB: 发送 activateWindow
        A-->>OS: exit(0)
    end
    
    Note over M: 阶段7: 窗口创建
    M->>MW: new MainWindow()
    MW->>MW: initUI()
    MW->>MW: initTitleBar()
    MW->>MW: initLeftMenu()
    MW->>MW: initPages()
    MW->>MW: initTrayIcon()
    MW->>MW: initConnections()
    MW->>DB: registerService()
    
    Note over M: 阶段8: 显示窗口
    M->>MW: show()
    
    Note over M: 阶段9: 事件循环
    M->>A: exec()
    A-->>M: 退出码
```

### 平台适配流程

```mermaid
flowchart TD
    A[setQPAPlatform] --> B{架构检测}
    
    B -->|龙芯| C[设置 LoongArch 参数]
    C --> D[QTWEBENGINE_CHROMIUM_FLAGS<br/>--no-sandbox --disable-gpu]
    
    B -->|其他| E{会话类型检测}
    
    E -->|Wayland| F{混成器检测}
    F -->|TreeLand| G[QT_QPA_PLATFORM=wayland]
    F -->|其他| H[QT_QPA_PLATFORM=dxcb;xcb]
    
    E -->|X11| I[使用默认设置]
    
    D --> J[设置 WebEngine 参数]
    G --> J
    H --> J
    I --> J
    
    J --> K[--disable-gpu<br/>--enable-software-compositing]
```

---

## 应用下载安装流程

### 完整下载安装流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant AIP as AppIntoPage
    participant DLW as DownloadListWidget
    participant DI as DownloadItem
    participant DC as DownloadController
    participant A2 as aria2c
    participant SS as ssinstall
    participant SYS as 系统
    
    U->>AIP: 点击下载按钮
    AIP->>AIP: emit clickedDownloadBtn()
    Note over AIP: 下载按钮抖动动画
    
    AIP->>DLW: addItem(appInfo)
    
    alt 应用已在下载列表
        DLW->>DI: highlight()
        DLW-->>AIP: 返回
    end
    
    DLW->>DI: new DownloadItem()
    DI->>DI: 设置状态 Waiting
    
    alt 无其他下载任务
        DLW->>DI: startDownload()
    end
    
    DI->>DI: 设置状态 Downloading
    DI->>DC: startDownload(url, filename, metalink)
    
    DC->>DC: 构建 aria2 参数
    
    alt 存在 metalink
        DC->>A2: aria2c --follow-metalink
    else 使用镜像列表
        DC->>DC: getMirrorUrls()
        DC->>A2: aria2c [mirrors]
    end
    
    loop 下载进度
        A2-->>DC: 标准输出
        DC->>DC: parseAria2Output()
        DC-->>DI: downloadProcess(received, total, speed)
        DI->>DI: 更新进度条
    end
    
    A2-->>DC: 进程退出
    DC-->>DI: downloadFinished(success, filePath)
    
    alt 下载成功
        DI->>DI: 设置状态 Downloaded
        DI->>DI: install()
        
        alt 有其他安装任务
            DI->>DI: 等待 1 秒后重试
        end
        
        DI->>DI: 设置状态 Installing
        DI->>DI: 获取安装参数
        DI->>SS: pkexec ssinstall [args]
        
        SS->>SS: verify_signature()
        
        alt 原生安装
            SS->>SYS: dpkg -i
        else ACE 容器安装
            SS->>SYS: amber-ce-xxx dpkg -i
        end
        
        SS-->>DI: 退出码
        
        alt 安装成功
            DI->>DI: 设置状态 Installed
            DI->>U: 发送通知
        else 安装失败
            DI->>DI: 设置状态 Failed
        end
        
        DI-->>DLW: finished()
    else 下载失败
        DI->>DI: 设置状态 Failed
        DI-->>DLW: finished()
    end
    
    DLW->>DLW: startNextDownload()
```

### 下载状态机

```mermaid
stateDiagram-v2
    [*] --> Waiting: 添加到队列
    
    Waiting --> Downloading: startDownload()
    
    Downloading --> Downloaded: 下载成功
    Downloading --> Failed: 下载失败
    Downloading --> Cancelled: 用户取消
    
    Downloaded --> Installing: install()
    
    Installing --> Installed: 安装成功
    Installing --> Failed: 安装失败
    
    Cancelled --> [*]
    Failed --> [*]
    Installed --> [*]
    
    note right of Downloading
        超时 200 秒无进度
        自动重试最多 3 次
    end note
    
    note right of Installing
        使用全局锁
        防止并发安装
    end note
```

---

## URL 协议处理流程

### SPK URL 处理

```mermaid
flowchart TD
    A[接收 URL] --> B{来源}
    
    B -->|命令行参数| C[main() 处理]
    B -->|D-Bus 调用| D[DBusService.openUrl()]
    B -->|浏览器点击| E[xdg-open 触发]
    
    C --> F[MainWindow.openUrl()]
    D --> G[activateWindow()]
    G --> F
    E --> H{已有实例?}
    H -->|是| I[D-Bus openUrl]
    I --> D
    H -->|否| J[启动新实例]
    J --> C
    
    F --> K{解析 scheme}
    K -->|非 spk| L[忽略]
    K -->|spk| M{解析 host}
    
    M -->|store| N[handleStoreUrl]
    M -->|search| O[handleSearchUrl]
    M -->|其他| P[警告并忽略]
    
    N --> Q[解析 /category/appname]
    Q --> R[AppIntoPage.openUrl()]
    R --> S[SparkAPI.getAppInfo()]
    S --> T[显示应用详情]
    
    O --> U[解析 /keyword]
    U --> V[URL 解码]
    V --> W[设置搜索框]
    W --> X[执行搜索]
    X --> Y[显示搜索结果]
```

### URL 解析详情

```mermaid
sequenceDiagram
    participant EXT as 外部
    participant MW as MainWindow
    participant AIP as AppIntoPage
    participant ALP as AppListPage
    participant API as SparkAPI
    
    EXT->>MW: openUrl("spk://store/games/xxx")
    MW->>MW: QUrl 解析
    MW->>MW: 验证 scheme == "spk"
    MW->>MW: 提取 host = "store"
    MW->>MW: 提取 path = "/games/xxx"
    
    MW->>AIP: openUrl(url)
    AIP->>API: getAppInfo(url)
    API->>API: 解析 category = "games"
    API->>API: 解析 appname = "xxx"
    API->>API: 构建 API URL
    API-->>AIP: appInfoReady(json)
    
    MW->>MW: switchToPage(AppPageAppdetail)
```

---

## 主题切换流程

```mermaid
sequenceDiagram
    participant SYS as 系统设置
    participant PORTAL as Freedesktop Portal
    participant BUS as D-Bus
    participant TC as ThemeChecker
    participant MW as MainWindow
    participant ALP as AppListPage
    participant WE as WebEngine
    
    SYS->>PORTAL: 用户切换主题
    PORTAL->>BUS: emit SettingChanged
    BUS->>TC: onPortalSettingChanged()
    
    TC->>TC: 解析 namespace
    TC->>TC: 解析 key
    TC->>TC: 获取 color-scheme 值
    
    alt 主题变化
        TC->>TC: 更新 m_isDark
        TC-->>MW: emit themeChanged(isDark)
        
        MW->>ALP: setDarkMode(isDark)
        ALP->>WE: runJavaScript(themeScript)
        WE->>WE: 切换 CSS 主题
        
        MW->>MW: 更新 UI 控件样式
    end
```

### 主题检测源

```mermaid
flowchart TD
    subgraph "主题检测源"
        A[Freedesktop Portal<br/>org.freedesktop.portal.Settings]
        B[DTK<br/>DGuiApplicationHelper]
    end
    
    A --> C[ThemeChecker]
    B --> C
    
    C --> D{当前主题}
    D -->|color-scheme = 1| E[暗色模式]
    D -->|color-scheme = 2| F[亮色模式]
    D -->|其他| G[跟随系统]
    
    E --> H[isDark = true]
    F --> I[isDark = false]
    G --> J[读取系统设置]
    J --> H
    J --> I
```

---

## 页面导航流程

```mermaid
stateDiagram-v2
    [*] --> AppListPage: 启动
    
    AppListPage --> SearchListPage: 搜索
    AppListPage --> AppIntoPage: 点击应用
    AppListPage --> SettingsPage: 设置按钮
    
    SearchListPage --> AppIntoPage: 点击结果
    SearchListPage --> AppListPage: 返回
    
    AppIntoPage --> AppListPage: 返回 (从列表)
    AppIntoPage --> SearchListPage: 返回 (从搜索)
    
    SettingsPage --> AppListPage: 返回
    
    note right of AppIntoPage
        使用 QStack 记录历史
        返回时 pop 上一页
    end note
```

### 页面切换逻辑

```mermaid
flowchart TD
    A[用户操作] --> B{操作类型}
    
    B -->|点击分类| C[loadCategory]
    C --> D[switchToPage AppListPage]
    
    B -->|搜索| E[onSearch]
    E --> F[switchToPage SearchListPage]
    
    B -->|点击应用| G[appClicked]
    G --> H[记录当前页到历史]
    H --> I[switchToPage AppIntoPage]
    
    B -->|点击设置| J[onSettingsClicked]
    J --> K[记录当前页到历史]
    K --> L[switchToPage SettingsPage]
    
    B -->|点击返回| M[goBack]
    M --> N{历史栈非空?}
    N -->|是| O[pop 上一页]
    O --> P[switchToPage 上一页]
    N -->|否| Q[保持当前页]
```

---

## 搜索流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant SE as 搜索框
    participant MW as MainWindow
    participant SLP as SearchListPage
    participant API as SparkAPI
    participant SRV as 搜索服务器
    
    U->>SE: 输入关键词
    U->>SE: 按回车
    SE-->>MW: returnPressed()
    
    MW->>MW: 获取关键词
    MW->>MW: 验证非空
    
    MW->>SLP: search(keyword)
    SLP->>SLP: 显示加载状态
    
    SLP->>API: getSearchList(keyword)
    API->>API: URL 编码关键词
    API->>SRV: GET /appinfo/search?keyword=xxx
    
    SRV->>SRV: 全文搜索
    SRV-->>API: JSON 响应
    
    API-->>SLP: searchListReady(results)
    
    alt 有结果
        SLP->>SLP: 渲染结果列表
    else 无结果
        SLP->>SLP: 显示"无结果"
    end
    
    MW->>MW: switchToPage(SearchListPage)
    
    U->>SLP: 点击结果
    SLP-->>MW: appClicked(spkUrl)
    MW->>MW: 打开应用详情
```

---

## ACE 容器安装流程

```mermaid
flowchart TD
    A[开始安装] --> B{安装模式}
    
    B -->|native 标签| C[原生安装]
    B -->|amber-ce-* 标签| D[ACE 容器安装]
    B -->|无标签| E[尝试原生安装]
    
    C --> F[dpkg -i]
    F --> G{安装成功?}
    G -->|是| H[创建桌面快捷方式]
    G -->|否| I{可回退 ACE?}
    I -->|是| D
    I -->|否| J[安装失败]
    
    D --> K{指定 ACE 环境?}
    K -->|是| L[使用指定环境]
    K -->|否| M[自动检测环境]
    
    L --> N{ACE 已安装?}
    M --> N
    
    N -->|否| O[apt install ACE]
    O --> P{安装成功?}
    P -->|否| J
    P -->|是| Q[ACE 容器内安装]
    
    N -->|是| Q
    
    Q --> R[amber-ce-xxx dpkg -i]
    R --> S{安装成功?}
    S -->|是| T[修复依赖]
    T --> H
    S -->|否| J
    
    H --> U[完成]
    J --> U
```

### ACE 环境选择

```mermaid
flowchart TD
    A[自动检测环境] --> B{读取 /etc/os-release}
    
    B --> C{发行版}
    C -->|Debian Bookworm| D[amber-ce-bookworm]
    C -->|Debian Trixie| E[amber-ce-trixie]
    C -->|Deepin 23| F[amber-ce-deepin23]
    C -->|其他| G[amber-ce-sid]
    
    D --> H[检查环境可用性]
    E --> H
    F --> H
    G --> H
    
    H --> I{环境可用?}
    I -->|是| J[使用该环境]
    I -->|否| K[尝试下一个环境]
    K --> H
```

---

## 崩溃处理流程

```mermaid
flowchart TD
    A[程序崩溃<br/>SIGSEGV] --> B[crashHandler]
    
    B --> C[获取调用栈]
    C --> D[backtrace 30 层]
    D --> E[backtrace_symbols 解析]
    
    B --> F[收集系统信息]
    F --> G[CPU 架构]
    F --> H[发行版信息]
    F --> I[内存信息]
    F --> J[应用版本]
    
    E --> K[生成日志文件]
    G --> K
    H --> K
    I --> K
    J --> K
    
    K --> L[/tmp/spark_store_crash_log_时间戳.txt]
    
    L --> M[写入日志内容]
    M --> N[信号类型]
    M --> O[调用栈]
    M --> P[系统信息]
    
    N --> Q[xdg-open 打开日志]
    O --> Q
    P --> Q
    
    Q --> R[exit 1]
```

---

## 单实例控制流程

```mermaid
flowchart TD
    A[启动程序] --> B[setSingleInstance]
    
    B --> C{获取实例锁}
    C -->|成功| D[作为主实例运行]
    C -->|失败| E[已有实例运行]
    
    D --> F[注册 D-Bus 服务]
    F --> G[正常启动流程]
    
    E --> H{有命令行参数?}
    H -->|是| I[解析参数]
    I --> J{是 spk:// URL?}
    J -->|是| K[D-Bus 调用 openUrl]
    J -->|否| L[D-Bus 调用 activateWindow]
    
    H -->|否| L
    
    K --> M[等待响应]
    L --> M
    
    M --> N[exit 0]
```

---

## 模块依赖关系

### 整体架构

```mermaid
graph TB
    subgraph "应用层"
        APP[Application]
        MW[MainWindow]
    end
    
    subgraph "页面层"
        ALP[AppListPage]
        SLP[SearchListPage]
        AIP[AppIntoPage]
        SP[SettingsPage]
    end
    
    subgraph "控件层"
        DLW[DownloadListWidget]
        DI[DownloadItem]
    end
    
    subgraph "后端层"
        API[SparkAPI]
        DC[DownloadController]
        TC[ThemeChecker]
        DCU[DataCollectorAndUploader]
    end
    
    subgraph "工具层"
        HR[HttpRequest]
        UT[Utils]
        DBUS[DBusSparkStoreService]
    end
    
    subgraph "外部"
        A2[aria2]
        SS[ssinstall]
        SRV[服务器]
    end
    
    APP --> MW
    MW --> ALP
    MW --> SLP
    MW --> AIP
    MW --> SP
    MW --> DLW
    MW --> TC
    MW --> DBUS
    
    ALP --> API
    SLP --> API
    AIP --> API
    AIP --> DLW
    SP --> API
    
    DLW --> DI
    DI --> DC
    DI --> SS
    
    API --> HR
    DC --> A2
    DCU --> HR
    
    HR --> SRV
```

### 数据流

```mermaid
graph LR
    subgraph "输入"
        U[用户操作]
        URL[URL 协议]
        DBUS[D-Bus 调用]
    end
    
    subgraph "处理"
        MW[MainWindow]
        API[SparkAPI]
        DC[DownloadController]
    end
    
    subgraph "输出"
        UI[界面更新]
        FILE[文件下载]
        INSTALL[软件安装]
        NOTIFY[系统通知]
    end
    
    U --> MW
    URL --> MW
    DBUS --> MW
    
    MW --> API
    MW --> DC
    
    API --> UI
    DC --> FILE
    FILE --> INSTALL
    INSTALL --> NOTIFY
```

---

[上一篇: API 文档](07-API文档.md) | [返回目录](README.md) | [下一篇: 更新工具](09-更新工具.md)
